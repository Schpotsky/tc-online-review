<?xml version="1.0"?>

<project name="Online Review" default="build" basedir=".">
  <!-- property file defining the component's dependencies -->
  <property file="build.properties"/>

  <!-- Import the dependencies of this build file -->
  <import file="${basedir}/build-dependencies.xml"/>

  <!-- include ant contrib tasks -->
  <taskdef resource="net/sf/antcontrib/antlib.xml" classpath="${ant-contrib.jar}"/>

  <!-- COMPONENT PARAMETERS -->
  <property name="distfilename" value="review"/>

  <!-- DIRECTORY SETUP -->
  <property name="srcdir" value="src"/>

  <property name="configdir" value="conf"/>
  <property name="webdir" value="web"/>
  <property name="jboss_files" value="jboss_files"/>
  <property name="jboss_files_conf" value="${jboss_files}/conf"/>
  <property name="jboss_files_deploy" value="${jboss_files}/deploy"/>
  <property name="jboss_files_lib" value="${jboss_files}/lib"/>

  <property name="builddir" value="build/online_review" />
  <property name="build_conf" value="${builddir}/conf" />
  <property name="build_tests" value="${builddir}/tests" />
  <property name="build_shared" value="${builddir}/shared" />
  <property name="build_jboss_files" value="${builddir}/jboss_files" />
  <property name="build_jboss_files_conf" value="${build_jboss_files}/conf" />
  <property name="build_jboss_files_deploy" value="${build_jboss_files}/deploy" />
  <property name="build_classdir" value="${builddir}/classes" />
  <property name="build_testclassdir" value="${build_tests}/testClasses" />
  <property name="build_testconfdir" value="${build_tests}/conf" />
  <property name="build_distdir" value="${builddir}/dist" />
  <property name="build_explodedwar" value="${build_distdir}/exploded/${distfilename}.war" />
  <property name="build_lib" value="${builddir}/lib" />

  <property name="deploy-dir" value="${JBOSS_HOME}/server/default/deploy/${distfilename}.war"/>
  <property name="deploy-conf-dir" value="${JBOSS_HOME}/server/default/conf"/>
  <property name="deploy-deploy-dir" value="${JBOSS_HOME}/server/default/deploy"/>
  <property name="deploy-lib-dir" value="${JBOSS_HOME}/server/default/lib"/>

  <!-- EXECUTION TAGS -->
  <property name="debug" value="off"/>
  <property name="verbose" value="no"/>

  <!-- replaces variables in configuration files with values for the target environment -->
  <target name="tokenize">
    <mkdir dir="${build_conf}"/>
    <copy todir="${build_conf}" overwrite="true">
      <fileset dir="${configdir}">
        <exclude if="exclude.mockxmlauthenticator.xmlfile" name="mockxmlauthenticator.xml"/>
        <include name="**"/>
      </fileset>
    </copy>

    <replace dir="${build_conf}" replacefilterfile="${token.properties}">
      <include name="**/*.properties"/>
      <include name="**/*.xml"/>
      <include name="**/*.xsl"/>
      <include name="**/*.xsd"/>
    </replace>
  </target>

  <!-- replaces variables in configuration files with values for the target environment -->
  <target name="tokenize_shared_files">
    <mkdir dir="${build_shared}"/>

    <copy todir="${build_shared}" overwrite="true">
      <fileset dir="${shared_libdir}">
        <include name="**/*.properties"/>
        <include name="**/*.xml"/>
        <include name="**/*.xsl"/>
        <include name="**/*.xsd"/>
      </fileset>
    </copy>

    <replace dir="${build_shared}" replacefilterfile="${token.properties}">
      <include name="**/*.properties"/>
      <include name="**/*.xml"/>
      <include name="**/*.xsl"/>
      <include name="**/*.xsd"/>
    </replace>
  </target>

  <!-- copy jboss dependency files to jboss lib folder -->
  <target name="copy_shared_files" depends="tokenize_shared_files">
    <copy todir="${deploy-conf-dir}" overwrite="true">
      <fileset dir="${build_shared}"/>
    </copy>
    <copy todir="${deploy-lib-dir}" overwrite="true" verbose="${verbose}" flatten="true">
      <fileset dir="${shared_libdir}">
        <include name="${shared.jar.name}"/>
        <include name="${tcwebcommon.jar.name}"/>
      </fileset>
    </copy>
  </target>

  <!-- replaces variables in configuration files with values for the target environment -->
  <target name="tokenize_jboss_files">
    <mkdir dir="${build_jboss_files_conf}"/>
    <mkdir dir="${build_jboss_files_deploy}"/>

    <copy todir="${build_jboss_files_conf}" overwrite="true">
      <fileset dir="${jboss_files_conf}">
        <include name="**/*.properties"/>
        <include name="**/*.xml"/>
        <include name="**/*.xsl"/>
        <include name="**/*.xsd"/>
      </fileset>
    </copy>

    <copy todir="${build_jboss_files_conf}/distribution_scripts" overwrite="true">
      <fileset dir="${jboss_files_conf}/distribution_scripts" includes="**"/>
    </copy>

    <replace dir="${build_jboss_files_conf}" replacefilterfile="${token.properties}">
      <include name="**/*.properties"/>
      <include name="**/*.xml"/>
      <include name="**/*.xsl"/>
      <include name="**/*.xsd"/>
    </replace>

    <copy todir="${build_jboss_files_deploy}" overwrite="true">
      <fileset dir="${jboss_files_deploy}" includes="**"/>
    </copy>

    <mkdir dir="${build_jboss_files_deploy}/static.ear/static.war"/>
    <copy todir="${build_jboss_files_deploy}/static.ear/static.war" overwrite="true">
      <fileset dir="${webdir}">
        <include name="css/**/*"/>
        <include name="i/**/*"/>
        <include name="js/**/*"/>
      </fileset>
    </copy>

    <replace dir="${build_jboss_files_deploy}" replacefilterfile="${token.properties}">
      <include name="tcs_informix-ds.xml"/>
    </replace>
  </target>

  <!-- copy jboss dependency files to jboss lib folder -->
  <!-- Use this task carefully !!! -->
  <target name="copy_jboss_files" depends="tokenize_jboss_files">
    <copy todir="${deploy-conf-dir}" overwrite="true">
      <fileset dir="${build_jboss_files_conf}"/>
    </copy>
    <copy todir="${deploy-deploy-dir}" overwrite="true">
      <fileset dir="${build_jboss_files_deploy}"/>
    </copy>
    <copy todir="${deploy-deploy-dir}" overwrite="true">
      <fileset dir="${jboss_files_deploy}" excludes="tcs_informix-ds.xml" includes="**"/>
    </copy>
    <!--<mkdir dir="${deploy-deploy-dir}/static.ear/static.war"/>
    <copy todir="${deploy-deploy-dir}/static.ear/static.war" overwrite="true">
      <fileset dir="${webdir}">
        <include name="css/**/*"/>
        <include name="i/**/*"/>
        <include name="js/**/*"/>
      </fileset>
    </copy>-->
    <copy todir="${deploy-lib-dir}" overwrite="true" verbose="${verbose}" flatten="true">
      <fileset dir="${jboss_files_lib}"/>
    </copy>
  </target>

  <!-- builds deploys OR with dependencies -->
  <target name="first_deploy" depends="copy_shared_files, copy_jboss_files" />

  <target name="tokenize_all" depends="tokenize, tokenize_jboss_files, tokenize_shared_files" />

</project>
